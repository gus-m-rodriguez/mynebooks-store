@startuml Secuencia_RecuperarPassword
!theme plain
skinparam sequenceMessageAlign center
skinparam roundcorner 20
skinparam maxmessagesize 60

title Diagrama de Secuencia - Recuperar Contraseña\nMyneBooks Store

actor Usuario as "Usuario\n(Cliente)" #LightGreen
participant Frontend as "Frontend\n(React)" #LightBlue
participant Backend as "Backend API\n(Express)" #LightYellow
participant "Base de\nDatos" as BD #LightCoral
participant "Sistema de\nEmail" as Email #LightGray

== Solicitar Recuperación ==
Usuario -> Frontend: 1. Accede a "Olvidé mi contraseña"
Frontend -> Usuario: 2. Muestra formulario\n(ingresar email)

Usuario -> Frontend: 3. Ingresa email
Frontend -> Frontend: 4. Validar formato de email

Usuario -> Frontend: 5. Envía formulario
Frontend -> Backend: 6. POST /api/auth/forgot-password\n{email}

Backend -> Backend: 7. Validar email (Joi)
Backend -> BD: 8. SELECT usuario\nWHERE email = ?
BD -> Backend: 9. Resultado

alt Email no existe
    Backend -> Frontend: 10a. 200 OK: "Si el email existe, se enviará un enlace"
    note right of Backend: No revela si el email existe\n(seguridad)
    Frontend -> Usuario: 11a. Mostrar mensaje genérico
else Email existe
    Backend -> Backend: 10b. Generar token único\n(uuid o crypto.randomBytes)
    Backend -> Backend: 11b. Calcular fecha de expiración\n(ahora + 1 hora)
    
    Backend -> BD: 12b. UPDATE usuarios\nSET reset_password_token = ?,\nreset_password_expires = ?\nWHERE email = ?
    BD -> Backend: 13b. Token guardado
    
    Backend -> Email: 14b. Enviar email con enlace\n(enviarEmailRecuperacion)
    Email -> Email: 15b. Preparar email con:\n- Enlace: /reset-password?token=?
    Email -> Usuario: 16b. Email enviado
    note right of Email: Email contiene:\n- Enlace con token\n- Instrucciones\n- Expira en 1 hora
    
    Backend -> Frontend: 17b. 200 OK: "Si el email existe, se enviará un enlace"
    Frontend -> Usuario: 18b. Mostrar mensaje genérico
end

== Restablecer Contraseña ==
Usuario -> Email: 19. Abre email y hace clic en enlace
Email -> Frontend: 20. Redirige a /reset-password?token=?

Frontend -> Frontend: 21. Extraer token de URL
Frontend -> Usuario: 22. Muestra formulario\n(nueva contraseña, confirmar)

Usuario -> Frontend: 23. Ingresa nueva contraseña
Frontend -> Frontend: 24. Validar contraseña\n(mínimo 8 caracteres, etc.)

Usuario -> Frontend: 25. Envía formulario
Frontend -> Backend: 26. POST /api/auth/reset-password\n{token, password}

Backend -> Backend: 27. Validar datos (Joi)
Backend -> BD: 28. SELECT usuario\nWHERE reset_password_token = ?\nAND reset_password_expires > NOW()
BD -> Backend: 29. Resultado

alt Token inválido o expirado
    Backend -> Frontend: 30a. Error 400: Token inválido o expirado
    Frontend -> Usuario: 31a. Mostrar mensaje de error
else Token válido
    Backend -> Backend: 30b. Hash de nueva contraseña\n(bcrypt, 10 rounds)
    Backend -> BD: 31b. UPDATE usuarios\nSET password_hash = ?,\nreset_password_token = NULL,\nreset_password_expires = NULL\nWHERE reset_password_token = ?
    BD -> Backend: 32b. Contraseña actualizada
    
    Backend -> BD: 33b. INSERT INTO auditoria\n(tipo='password_reseteado')
    BD -> Backend: 34b. Registrado
    
    Backend -> Frontend: 35b. 200 OK: Contraseña restablecida
    Frontend -> Usuario: 36b. Mostrar mensaje de éxito
    Frontend -> Frontend: 37b. Redirigir a /login
    Usuario -> Frontend: 38b. Puede iniciar sesión\ncon nueva contraseña
end

@enduml

